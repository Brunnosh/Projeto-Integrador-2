<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento</title>
    <link rel="stylesheet" type="text/css" href="/FRONTEND/src/assets/css/pagamento.css">
    <style>
        .statusError{
           color:red;
        }
        .statusSuccess{
          color:blue;
        }
    </style>
    <script>


    const aeronaveEscolhida = sessionStorage.getItem("aeronaveEscolhida");
    const assentosEscolhidos = sessionStorage.getItem("assentosEscolhidos");
    const ndeAssentos = sessionStorage.getItem("ndeAssentos");
    const cpfPassageiro = sessionStorage.getItem("cpfPassageiro");
    const vooEscolhido = sessionStorage.getItem("vooEscolhido");
    const custo = ndeAssentos * 150;
    const custodisplay = custo + "R$"

    
    
    //Funções não especificas
    
    //deixa os inputs de nome e cpf invisiveis caso checkado a opção
    document.addEventListener("DOMContentLoaded", async function () {
        var divCusto =  document.getElementById("custo");
        divCusto.textContent = custodisplay;

        if(ndeAssentos > 1){
            const divcheckbox = document.getElementById("divcheckbox");
            divcheckbox.style.display = "block";
        }
        if(ndeAssentos > 1)
        {   
            const checkbox = document.getElementById("assentosunico")
            if(checkbox.checked){
                addElement(ndeAssentos);
            }
            
        }

        



    });
    
    //funcão para formatar o cpf
    document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('input', function(event) {
        const target = event.target;

        if (target.classList.contains('cpf-input')) {
            const inputValue = event.data;

            if (!/\d/.test(inputValue)) {
                // Remove caracteres não numéricos
                target.value = target.value.replace(/\D/g, '');
            }

            let inputLength = target.value.length;

            // Formatação do CPF
            if (inputLength === 3 || inputLength === 7) {
                target.value = target.value + '.';
            } else if (inputLength === 11) {
                target.value = target.value + '-';
            }
        }
    });
});

    //função para adicionar os campos de nome e cpf
    function addElement(n){
        const divAssentos = document.getElementById("divAssentos");
        divAssentos.innerHTML = "";
        for (let i = 0; i < n; i++) {
            const newDiv = document.createElement("div");
            const nameLabel = document.createElement("label");
            const nameInput = document.createElement("input");
            const cpfLabel = document.createElement("label");
            const cpfInput = document.createElement("input");

            nameLabel.textContent = "Nome:" + (i + 1);
            nameInput.type = "text";
            nameInput.name = `nomeAssento${i + 1}`; // Correção aqui
            

            cpfLabel.textContent = "CPF:" + (i + 1);
            cpfInput.type = "text";
            cpfInput.placeholder = "123.456.789-01";
            cpfInput.name = `cpfAssento${i + 1}`; // Correção aqui
            cpfInput.maxLength = 14;
            cpfInput.classList.add('cpf-input');
           
            newDiv.appendChild(nameLabel);
            newDiv.appendChild(nameInput);
            newDiv.appendChild(document.createElement("br")); // Adiciona uma quebra de linha
            newDiv.appendChild(cpfLabel);
            newDiv.appendChild(cpfInput);
            divAssentos.appendChild(newDiv);
            

            }
        
    }
    
    function atualizarStatusDisponibilidade() {
        
        const divAssentos = document.getElementById("divAssentos");
        const divs = divAssentos.querySelectorAll("div");
        var checkbox = document.getElementById("assentosunico");
        var statusSpan = document.getElementById("statusDisponibilidade");

        divs.forEach(div => {
        div.style.display = checkbox.checked ? "none" : "block";
    });


        if (checkbox.checked) {
            statusSpan.textContent = "Sim";
            
        } else {
            statusSpan.textContent = "Não";
        }
        }

    function showStatusMessage(msg, error) {
        var pStatus = document.getElementById("status");
        if (error === true) {
            pStatus.className = "statusError";
        } else {
            pStatus.className = "statusSuccess";
        }
        pStatus.textContent = msg;
    }

    //
    //Funções de validação
    function selecionouPagamento(){
            let resultado = false; 
            var radial = document.querySelector('input[name="modoPagamento"]:checked');
          
            if (radial){
            console.log('Radio button selecionado:', radial.value);
            resultado = true;
            }
            return resultado;
        }

    function preencheuTudo(){
            let resultado = true; 
            for(let i=0;i<ndeAssentos;i++){
                const cpfInput = document.querySelector(`input[name="cpfAssento${i + 1}"]`);
                const nomeInput = document.querySelector(`input[name="nomeAssento${i + 1}"]`);

                console.log(`CPF ${i + 1}: "${cpfInput.value}"`);
                console.log(`Nome ${i + 1}: "${nomeInput.value}"`);

                if (cpfInput.value.trim() == "" || nomeInput.value.trim() == "") {
                    console.log("bunda")
                    resultado = false;
                break;
                }
            }
            console.log(resultado)
            return resultado;
    }

    //

    //Fetch que acessam o backend

    function fetchInserirPagamento(body) {
        const requestOptions = {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        };

        return fetch('http://localhost:3000/inserirPagamento', requestOptions)
        .then(T => T.json())
      }

    function fetchReservarAssento(body) {
        const requestOptions = {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        };

        return fetch('http://localhost:3000/inserirAssento', requestOptions)
        .then(T => T.json())
    }

    function fetchCadastro(body) {
        const requestOptions = {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        };

        return fetch('http://localhost:3000/inserirCliente', requestOptions)
        .then(T => T.json())
    }

    function fetchListarCliente(body) {
        const requestOptions = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        };

        return fetch('http://localhost:3000/loginCliente', requestOptions)
        .then(data => {
        return data;
        });
      }

    //

    //Funções criadas para limpar outras funções
    async function inserirCadastro(cpfinserirlogin,nomeinserirlogin){
        console.log(cpfinserirlogin,nomeinserirlogin)
                
            fetchCadastro({
            nome: nomeinserirlogin, 
            cpf: cpfinserirlogin
            })
            .then(resultado => {
            
            if(resultado.status === "SUCCESS"){

            }else{
                showStatusMessage("Erro ao criar conta " + message, true);
                console.log(resultado.message);
            }
            })
            .catch(()=>{
            showStatusMessage("Erro técnico ao cadastrar... Contate o suporte.", true);
            console.log("Falha grave ao cadastrar.")
            });
    }

    async function reservarAssento(isADM,assentoEscolhido, cpfassento){
        fetchReservarAssento({
                isADM: isADM, 
                aeronave: aeronaveEscolhida,
                assento: assentoEscolhido, 
                cpfpassageiro: cpfassento,
                numvoo : vooEscolhido
                })
                .then(resultado => {
                        
                if(resultado.status === "SUCCESS"){
                            
                                }else{
                showStatusMessage("Erro ao criar conta " + message, true);
                console.log(resultado.message);
                }
                })
                .catch(()=>{
                showStatusMessage("Erro técnico ao cadastrar... Contate o suporte.", true);
                console.log("Falha grave ao cadastrar.")
            });
    }

    async function listarCliente(nomeassentos,cpfassentos){
        var nomeinserirlogin  = nomeassentos;
        var cpfinserirlogin = cpfassentos;

        for(let i = 0; i<ndeAssentos;i++)
            {
                const response = await fetchListarCliente({
                cpf: cpfassentos[i]
                });
                const data = await response.json();

                if (data.status === "SUCCESS") {
                    if(data.payload.length == 0){
                        continue;
                    }
                    // se encontrou conta com CPF
                    // remover cpf e o nome das listas para inserir
                    const cliente = data.payload[0];
                    const nomecliente = cliente[0].toUpperCase();

            
                    nomeinserirlogin = nomeinserirlogin.filter(nome => nome !== nomecliente);
                    cpfinserirlogin = cpfinserirlogin.filter(cpf => cpf !== cpfassentos[i]);

                    } 
                    else {
                    showStatusMessage("Erro ao buscar info " + data.message, true);
                    
                    }

                    console.log(cpfinserirlogin,nomeinserirlogin)
            }
            return { nomeinserirlogin, cpfinserirlogin };
    }

    //

    //Função que realiza tudo
    async function pagarassentos1()
    {
        const isADM = 0;
        var radial = document.querySelector('input[name="modoPagamento"]:checked');
        var modo_pagamento = radial.id;

        await fetchInserirPagamento({
        cpf: cpfPassageiro, 
        custo: custo,
        qtd_paga: custo, 
        modo_pagamento: modo_pagamento
        })
        .then(resultado => {
        
        if(resultado.status === "SUCCESS"){
            fetchReservarAssento({
            isADM: isADM, 
            aeronave: aeronaveEscolhida,
            assento: assentosEscolhidos, 
            cpfpassageiro: cpfPassageiro,
            numvoo : vooEscolhido
            })
            .then(resultado => {
        
            if(resultado.status === "SUCCESS"){
            alert("Compra efetuada e assentos reservados!");
            window.location.href = "/FRONTEND/src/modules/cliente/menucliente.html";
            
                }else{
            showStatusMessage("Erro ao criar conta " + message, true);
            console.log(resultado.message);
            }
            })
            .catch(()=>{
            showStatusMessage("Erro técnico ao cadastrar... Contate o suporte.", true);
            console.log("Falha grave ao cadastrar.")
            });
            
        }else{
            showStatusMessage("Erro ao criar conta " + message, true);
            console.log(resultado.message);
        }
        })
        .catch(()=>{
        showStatusMessage("Erro técnico ao cadastrar... Contate o suporte.", true);
        console.log("Falha grave ao cadastrar.")
        });




    }
    
    async function pagarassentosmaisq1()
    {
        const isADM = 0;
        var radial = document.querySelector('input[name="modoPagamento"]:checked');
        var modo_pagamento = radial.id;
        const checkbox = document.getElementById("assentosunico")

        if(checkbox.checked){
            await fetchInserirPagamento({
                cpf: cpfPassageiro, 
                custo: custo,
                qtd_paga: custo, 
                modo_pagamento: modo_pagamento
                })
                .then(resultado => {
                
                if(resultado.status === "SUCCESS"){
                    for (let i = 0; i < ndeAssentos; i++) {
                        fetchReservarAssento({
                            isADM: isADM, 
                            aeronave: aeronaveEscolhida,
                            assento: JSON.parse(assentosEscolhidos)[i], 
                            cpfpassageiro: cpfPassageiro,
                            numvoo : vooEscolhido
                            })
                            .then(resultado => {
                        
                            if(resultado.status === "SUCCESS"){
                            
                                }else{
                            showStatusMessage("Erro ao criar conta " + message, true);
                            console.log(resultado.message);
                            }
                            })
                            .catch(()=>{
                            showStatusMessage("Erro técnico ao cadastrar... Contate o suporte.", true);
                            console.log("Falha grave ao cadastrar.")
                            });
                    }
                    
                }else{
                    showStatusMessage("Erro ao criar conta " + message, true);
                    console.log(resultado.message);
                }
                })
                .catch(()=>{
                showStatusMessage("Erro técnico ao cadastrar... Contate o suporte.", true);
                console.log("Falha grave ao cadastrar.")
                });

            alert("Compra efetuada e assentos reservados!");
            window.location.href = "/FRONTEND/src/modules/cliente/menucliente.html";
        }
        
        if(!checkbox.checked){
            var cpfassentos = []
            var nomeassentos = []
            for(let i = 0; i<ndeAssentos;i++)
            {
                cpfassentos.push(document.querySelector(`input[name="cpfAssento${i + 1}"]`).value)
                nomeassentos.push(document.querySelector(`input[name="nomeAssento${i + 1}"]`).value)
            }

            nomeassentos = nomeassentos.map(function(string) {
                return string.toUpperCase();
            });

            
            const { nomeinserirlogin, cpfinserirlogin } = await listarCliente(nomeassentos, cpfassentos);

            for(let i =0; i< cpfinserirlogin.length ; i++)
            {
                inserirCadastro(cpfinserirlogin[i],nomeinserirlogin[i]);
            }

            await fetchInserirPagamento({
                cpf: cpfPassageiro, 
                custo: custo,
                qtd_paga: custo, 
                modo_pagamento: modo_pagamento
                })
                .then(resultado => {
                
                if(resultado.status === "SUCCESS"){
                    for (let i = 0; i < ndeAssentos; i++) {
                        reservarAssento(isADM,JSON.parse(assentosEscolhidos)[i],cpfassentos[i]);

                    }
                    
                }else{
                    showStatusMessage("Erro ao criar conta " + message, true);
                    console.log(resultado.message);
                }
                })
                .catch(()=>{
                showStatusMessage("Erro técnico ao cadastrar... Contate o suporte.", true);
                console.log("Falha grave ao cadastrar.")
                });


            alert("Compra efetuada e assentos reservados!");
            window.location.href = "/FRONTEND/src/modules/cliente/menucliente.html";

        }

    }

    //

    //Funcão final que governa o que acontecerá com base no numero de assentos reservados
    async function pagar(){

        if(!selecionouPagamento()){
          showStatusMessage("Selecione metodo de pagamento...", true);  
          return;
        }

        
        

        if(ndeAssentos == 1){
            await pagarassentos1();
        }

        if(ndeAssentos > 1){
            const checkbox = document.getElementById("assentosunico")
            if(checkbox.checked){
                await pagarassentosmaisq1();
            }
            if(!checkbox.checked){
                if(!preencheuTudo()){
                showStatusMessage("Preencha todos os campos...", true);  
                return;
                await pagarassentosmaisq1();
            }


        }

            

        }


    }

    //

    window.onload = function () {
        addElement(ndeAssentos);
        atualizarStatusDisponibilidade();
    }
    </script>
    

</head>
<body>
    <div id="seat-map"></div>


    <div class="container">
        <h1>Pagamento</h1>
        <form id="cadastro-form">

            <div class="form-group">
                <p>Modo de Pagamento:</p>
                <div class="radio-group">
                    <label for="pix">Pix :</label>
                    <input type="radio" name="modoPagamento" id="pix" value="pix"/>
                </div>
                <div class="radio-group">
                    <label for="credito">Crédito:</label>
                    <input type="radio" name="modoPagamento" id="credito" value="credito"/>
                </div>
                <div class="radio-group">
                    <label for="debito">Débito:</label>
                    <input type="radio" name="modoPagamento" id="debito" value="debito"/>
                </div>
                <div>
                    <p>Quantia a pagar:</p>
                    <div id="custo"></div>
                </div>
                <div class="radio-group" style="display: none" id="divcheckbox">
                    <label for="assentosunico">Todos os assentos são seus? :</label>
                    <input type="checkbox" id="assentosunico" onchange="atualizarStatusDisponibilidade()"/>
                    <span id="statusDisponibilidade"></span>    
                </div>
                <div id="divAssentos"></div>
                <div class="btn-group">
                    <button type="button" class="btn" onclick="pagar()">Pagar e reservar assento(s)</button>
                </div>
            </div>
            <p id="status" class="statusError"></p>
        </form>
    </div>


</body>
</html>
